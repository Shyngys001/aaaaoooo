<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Ultimate v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #d4af37;
            --text: #1a1a1a;
            --border: #e5e7eb;
            --bg: #f8f9fa;
        }
        body { font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text); background: var(--bg); }
        .app-container { display: flex; min-height: 100vh; }
        .editor-panel { width: 440px; background: white; border-right: 1px solid var(--border); overflow-y: auto; position: sticky; top: 0; height: 100vh; }
        .editor-header { padding: 24px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--primary), #b8941f); color: white; }
        .editor-header h1 { font-size: 24px; margin-bottom: 4px; }
        .lang-switcher { display: flex; gap: 8px; margin-top: 16px; }
        .lang-btn { padding: 8px 16px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .lang-btn.active { background: white; color: var(--primary); }
        .editor-content { padding: 24px; }
        .form-section { margin-bottom: 32px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ''; width: 4px; height: 20px; background: var(--primary); border-radius: 2px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(212,175,55,0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 12px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-height: 44px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #b8941f); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: white; color: #2c3e50; border: 2px solid var(--border); }
        .btn-small { padding: 8px 16px; font-size: 13px; min-height: 36px; }
        .btn-delete { background: #fee; color: #ef4444; border: 1px solid #fcc; padding: 8px; cursor: pointer; }
        .btn-delete:hover { background: #ef4444; color: white; }
        .button-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .template-card { border: 2px solid var(--border); border-radius: 12px; padding: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .template-card:hover { border-color: var(--primary); }
        .template-card.active { border-color: var(--primary); background: rgba(212,175,55,0.1); }
        .template-card h4 { font-size: 13px; margin-bottom: 4px; }
        .template-card p { font-size: 11px; color: #666; }
        .list-item { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .collapsible-header { display: flex; justify-content: space-between; padding: 16px; background: var(--bg); border-radius: 8px; cursor: pointer; user-select: none; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .collapsible-content.open { max-height: 5000px; }
        .collapsible-content-inner { padding: 16px 0; }
        .preview-container { flex: 1; padding: 32px; overflow-y: auto; background: linear-gradient(to bottom, #f0f0f0, #e8e8e8); }
        #previewSheet { background: white; box-shadow: 0 20px 25px rgba(0,0,0,0.1); margin: 0 auto; max-width: 1200px; }
        .toast { position: fixed; top: 24px; right: 24px; background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 20px 25px rgba(0,0,0,0.1); z-index: 1000; transform: translateX(400px); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid #10b981; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Photo List in Editor */
        .photo-list { margin-top: 8px; }
        .photo-item { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .photo-item input { flex: 1; }
        .photo-item .btn-delete { min-width: 36px; }
        
        /* Contact Footer */
        .contact-footer { background: var(--bg); border-top: 2px solid var(--border); padding: 32px; margin-top: 48px; display: flex; justify-content: center; align-items: center; gap: 32px; flex-wrap: wrap; }
        .contact-item { display: flex; align-items: center; gap: 8px; font-size: 16px; }
        .wa-button { display: inline-flex; align-items: center; gap: 8px; padding: 16px 24px; background: #25D366; color: white; text-decoration: none; border-radius: 12px; font-weight: 600; transition: all 0.2s; }
        .wa-button:hover { background: #20BA5A; transform: translateY(-2px); }
        
        /* CTA Section */
        .cta-section { background: linear-gradient(135deg, var(--primary), #b8941f); color: white; padding: 48px; text-align: center; margin: 48px 0; border-radius: 16px; }
        .cta-section h3 { font-size: 32px; margin-bottom: 16px; }
        .cta-section p { font-size: 18px; margin-bottom: 24px; opacity: 0.9; }
        .cta-section .btn { background: white; color: var(--primary); font-size: 18px; padding: 16px 32px; }
        
        /* NEW: Stylish Modern Template */
        .template-stylish-modern { font-family: 'Inter', sans-serif; }
        .template-stylish-modern .hero-modern { display: grid; grid-template-columns: 1fr 1fr; min-height: 600px; gap: 48px; padding: 64px; align-items: center; }
        .template-stylish-modern .hero-text h1 { font-size: 56px; font-weight: 700; margin-bottom: 16px; line-height: 1.1; }
        .template-stylish-modern .hero-text h2 { font-size: 42px; font-weight: 300; margin-bottom: 16px; color: #666; }
        .template-stylish-modern .hero-text p { font-size: 18px; color: #888; }
        .template-stylish-modern .hero-image { width: 100%; height: 100%; min-height: 500px; object-fit: cover; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transition: transform 0.3s; }
        .template-stylish-modern .hero-image:hover { transform: scale(1.02); }
        .template-stylish-modern .content-section { max-width: 1200px; margin: 0 auto; padding: 64px 32px; }
        .template-stylish-modern .section-heading { font-size: 36px; font-weight: 600; margin-bottom: 48px; text-align: center; }
        .template-stylish-modern .hotels-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 32px; margin-bottom: 64px; }
        .template-stylish-modern .hotel-card { border: 1px solid #e0e0e0; border-radius: 16px; overflow: hidden; transition: all 0.3s; }
        .template-stylish-modern .hotel-card:hover { box-shadow: 0 12px 24px rgba(0,0,0,0.1); transform: translateY(-4px); }
        .template-stylish-modern .hotel-photos { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; height: 260px; }
        .template-stylish-modern .hotel-photos img { width: 100%; height: 100%; object-fit: cover; }
        .template-stylish-modern .hotel-info { padding: 24px; }
        .template-stylish-modern .hotel-city { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: #999; }
        .template-stylish-modern .hotel-name { font-size: 24px; font-weight: 600; margin: 8px 0; }
        .template-stylish-modern .hotel-meta { font-size: 14px; color: #666; margin-top: 8px; }
        .template-stylish-modern .prices-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 64px; }
        .template-stylish-modern .price-card { border: 1px solid #e0e0e0; border-radius: 16px; padding: 32px; text-align: center; transition: all 0.3s; }
        .template-stylish-modern .price-card:hover { border-color: var(--primary); box-shadow: 0 8px 16px rgba(212,175,55,0.2); }
        .template-stylish-modern .price-label { font-size: 14px; color: #666; margin-bottom: 16px; }
        .template-stylish-modern .price-value { font-size: 36px; font-weight: 700; color: var(--primary); }
        .template-stylish-modern .services-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 64px; }
        .template-stylish-modern .service-card { padding: 24px; border: 1px solid #e0e0e0; border-radius: 12px; text-align: center; }
        .template-stylish-modern .service-icon { font-size: 48px; margin-bottom: 16px; }
        .template-stylish-modern .service-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .template-stylish-modern .service-desc { font-size: 14px; color: #666; }
        .template-stylish-modern .transfer-list { display: grid; gap: 16px; margin-bottom: 64px; }
        .template-stylish-modern .transfer-item { display: flex; gap: 16px; padding: 24px; border: 1px solid #e0e0e0; border-radius: 12px; }
        .template-stylish-modern .transfer-icon { font-size: 32px; min-width: 48px; }
        
        /* NEW: Apple Style Template */
        .template-apple-style { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%); }
        .template-apple-style .glass-header { padding: 80px 32px; text-align: center; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); backdrop-filter: blur(20px); }
        .template-apple-style .brand-name { font-size: 64px; font-weight: 800; margin-bottom: 16px; letter-spacing: -0.03em; }
        .template-apple-style .package-title { font-size: 72px; font-weight: 800; margin-bottom: 16px; letter-spacing: -0.04em; background: linear-gradient(135deg, var(--primary), #b8941f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .template-apple-style .package-subtitle { font-size: 24px; color: #666; }
        .template-apple-style .content { max-width: 1200px; margin: 0 auto; padding: 64px 32px; }
        .template-apple-style .section-heading { font-size: 48px; font-weight: 700; margin-bottom: 48px; text-align: center; }
        .template-apple-style .hotels-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 32px; margin-bottom: 64px; }
        .template-apple-style .hotel-glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); border-radius: 24px; overflow: hidden; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .template-apple-style .hotel-photos-glass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; height: 280px; }
        .template-apple-style .hotel-photos-glass img { width: 100%; height: 100%; object-fit: cover; }
        .template-apple-style .hotel-info-glass { padding: 32px; }
        .template-apple-style .hotel-city-glass { font-size: 12px; text-transform: uppercase; letter-spacing: 0.15em; color: #999; }
        .template-apple-style .hotel-name-glass { font-size: 32px; font-weight: 700; margin: 12px 0; }
        .template-apple-style .prices-billboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; margin-bottom: 64px; }
        .template-apple-style .price-billboard { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); border-radius: 24px; padding: 48px 32px; text-align: center; border: 1px solid rgba(255,255,255,0.5); }
        .template-apple-style .price-label-big { font-size: 16px; color: #666; margin-bottom: 24px; }
        .template-apple-style .price-value-big { font-size: 64px; font-weight: 800; letter-spacing: -0.02em; background: linear-gradient(135deg, var(--primary), #b8941f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .template-apple-style .services-glass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 64px; }
        .template-apple-style .service-glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); border-radius: 20px; padding: 32px; text-align: center; border: 1px solid rgba(255,255,255,0.5); }
        .template-apple-style .service-icon-glass { font-size: 56px; margin-bottom: 16px; }
        .template-apple-style .transfer-glass-list { display: grid; gap: 16px; margin-bottom: 64px; }
        .template-apple-style .transfer-glass-item { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; display: flex; gap: 16px; border: 1px solid rgba(255,255,255,0.5); }
        
        /* NEW: Modern Minimal Aesthetic Template */
        .template-modern-minimal { font-family: 'Inter', sans-serif; max-width: 960px; margin: 0 auto; padding: 80px 32px; }
        .template-modern-minimal .header-minimal { text-align: center; margin-bottom: 80px; padding-bottom: 40px; border-bottom: 1px solid #e0e0e0; }
        .template-modern-minimal .brand-name-minimal { font-size: 48px; font-weight: 300; margin-bottom: 16px; }
        .template-modern-minimal .package-title-minimal { font-size: 64px; font-weight: 600; margin-bottom: 16px; line-height: 1.1; }
        .template-modern-minimal .package-subtitle-minimal { font-size: 20px; color: #666; }
        .template-modern-minimal .section-heading-minimal { font-size: 32px; font-weight: 500; margin: 64px 0 32px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0; }
        .template-modern-minimal .hotels-minimal { display: grid; grid-template-columns: repeat(2, 1fr); gap: 32px; margin-bottom: 64px; }
        .template-modern-minimal .hotel-minimal { border: 1px solid #e0e0e0; border-radius: 0; overflow: hidden; }
        .template-modern-minimal .hotel-photos-minimal { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; height: 200px; }
        .template-modern-minimal .hotel-photos-minimal img { width: 100%; height: 100%; object-fit: cover; }
        .template-modern-minimal .hotel-info-minimal { padding: 24px; }
        .template-modern-minimal .hotel-city-minimal { font-size: 11px; text-transform: uppercase; letter-spacing: 0.15em; color: #999; }
        .template-modern-minimal .hotel-name-minimal { font-size: 22px; font-weight: 500; margin: 8px 0; }
        .template-modern-minimal .prices-tabs { display: flex; gap: 2px; margin-bottom: 32px; }
        .template-modern-minimal .price-tab { flex: 1; padding: 24px; text-align: center; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
        .template-modern-minimal .price-tab:hover { background: #f8f9fa; }
        .template-modern-minimal .price-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .template-modern-minimal .price-tab-label { font-size: 14px; margin-bottom: 12px; }
        .template-modern-minimal .price-tab-value { font-size: 28px; font-weight: 700; }
        .template-modern-minimal .services-minimal { margin-bottom: 64px; }
        .template-modern-minimal .service-minimal { display: flex; gap: 16px; padding: 20px 0; border-bottom: 1px solid #e0e0e0; }
        .template-modern-minimal .service-icon-minimal { font-size: 32px; min-width: 48px; }
        .template-modern-minimal .service-title-minimal { font-size: 18px; font-weight: 500; margin-bottom: 4px; }
        .template-modern-minimal .transfer-minimal-list { margin-bottom: 64px; }
        .template-modern-minimal .transfer-minimal-item { display: flex; gap: 16px; padding: 20px 0; border-bottom: 1px solid #e0e0e0; }
        
        @media print {
            .editor-panel { display: none !important; }
            .preview-container { padding: 0; background: white; }
            #previewSheet { box-shadow: none; max-width: none; }
        }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .editor-panel { width: 100%; height: auto; position: relative; }
            .template-grid { grid-template-columns: 1fr; }
            .template-stylish-modern .hero-modern,
            .template-stylish-modern .hotels-grid,
            .template-stylish-modern .prices-grid,
            .template-stylish-modern .services-grid,
            .template-apple-style .hotels-grid,
            .template-apple-style .prices-billboard,
            .template-apple-style .services-glass,
            .template-modern-minimal .hotels-minimal { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="editor-panel">
            <div class="editor-header">
                <h1>ATLAS Ultimate v3.0</h1>
                <p>Premium Package Generator</p>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="ru" onclick="setLang('ru')">RU</button>
                    <button class="lang-btn" data-lang="kk" onclick="setLang('kk')">KK</button>
                </div>
            </div>
            
            <div class="editor-content">
                <section class="form-section">
                    <h3 class="section-title">–ë—Ä–µ–Ω–¥–∏–Ω–≥</h3>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</label>
                        <input type="text" id="brandName" value="ATLAS">
                    </div>
                    <div class="form-group">
                        <label>–°–ª–æ–≥–∞–Ω</label>
                        <input type="text" id="tagline" value="Premium Travel">
                    </div>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">–ü–∞–∫–µ—Ç</h3>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="packageTitle" value="Umrah 2025">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="packageSubtitle" value="–°–≤—è—â–µ–Ω–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ">
                    </div>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">–®–∞–±–ª–æ–Ω</h3>
                    <div class="template-grid">
                        <div class="template-card active" data-template="stylish-modern"><h4>Stylish Modern</h4><p>Hero + Grid</p></div>
                        <div class="template-card" data-template="apple-style"><h4>Apple Style</h4><p>Glass Panels</p></div>
                        <div class="template-card" data-template="modern-minimal"><h4>Modern Minimal</h4><p>Clean Lines</p></div>
                        <div class="template-card" data-template="minimal-column"><h4>Minimal Column</h4><p>Narrow Flow</p></div>
                        <div class="template-card" data-template="minimal-split"><h4>Minimal Split</h4><p>Split Header</p></div>
                        <div class="template-card" data-template="minimal-timeline"><h4>Minimal Timeline</h4><p>Timeline</p></div>
                    </div>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">–û—Ç–µ–ª–∏</h3>
                    <div id="hotelsList"></div>
                    <button class="btn btn-secondary btn-small" id="addHotel">+ –û—Ç–µ–ª—å</button>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">–¶–µ–Ω—ã</h3>
                    <div id="pricesList"></div>
                    <button class="btn btn-secondary btn-small" id="addPrice">+ –¶–µ–Ω–∞</button>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">–£—Å–ª—É–≥–∏</h3>
                    <div id="servicesList"></div>
                    <button class="btn btn-secondary btn-small" id="addService">+ –£—Å–ª—É–≥–∞</button>
                </section>
                
                <section class="form-section">
                    <h3 class="section-title">üöê –¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∏ –ì–∏–¥</h3>
                    <div id="transferList"></div>
                    <button class="btn btn-secondary btn-small" id="addTransfer">+ –¢—Ä–∞–Ω—Å—Ñ–µ—Ä</button>
                </section>
                
                <div style="margin-bottom: 24px;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span style="font-weight: 600;">CTA WhatsApp</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner" id="ctaEditor"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span style="font-weight: 600;">–ö–æ–Ω—Ç–∞–∫—Ç—ã (–Ω–∏–∑)</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner" id="contactEditor"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span style="font-weight: 600;">–¢–µ–∫—Å—Ç—ã/–ü–µ—Ä–µ–≤–æ–¥—ã</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner" id="textsEditor"></div>
                    </div>
                </div>
                
                <section class="form-section">
                    <h3 class="section-title">–î–µ–π—Å—Ç–≤–∏—è</h3>
                    <div class="button-group">
                        <button class="btn btn-primary" id="exportPDF">üìÑ PDF</button>
                        <button class="btn btn-secondary btn-small" id="saveJSON">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary btn-small" id="loadJSON">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                    <input type="file" id="jsonInput" accept=".json" style="display: none;">
                </section>
            </div>
        </aside>
        
        <main class="preview-container">
            <div id="previewSheet"></div>
        </main>
    </div>
    
    <div id="toast" class="toast"></div>
    <div id="loadingOverlay" class="loading-overlay">
        <div style="background: white; padding: 32px; border-radius: 24px; text-align: center;">
            <div class="spinner"></div>
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ PDF...</h3>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        const i18n = { lang: localStorage.getItem('atlasLang') || 'ru' };
        function t(key) { return (state.texts[key]?.[i18n.lang]) ?? state.texts[key]?.ru ?? key; }
        function setLang(code) {
            i18n.lang = code;
            localStorage.setItem('atlasLang', code);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === code);
            });
            render();
        }
        
        let state = {
            template: 'stylish-modern',
            brandName: 'ATLAS',
            tagline: 'Premium Travel',
            packageTitle: 'Umrah 2025',
            packageSubtitle: '–°–≤—è—â–µ–Ω–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ',
            hotels: [{
                city: '–ú–µ–∫–∫–∞', 
                name: 'Swiss√¥tel Makkah', 
                stars: 5, 
                rating: 9.2, 
                distance: '300–º –æ—Ç –•–∞—Ä–∞–º–∞',
                photos: [
                    'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800',
                    'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=800',
                    'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=800'
                ]
            }],
            prices: [
                { label: '4-–º–µ—Å—Ç–Ω—ã–π', value: '$1,500' },
                { label: '3-–º–µ—Å—Ç–Ω—ã–π', value: '$1,800' },
                { label: '2-–º–µ—Å—Ç–Ω—ã–π', value: '$2,200' }
            ],
            services: [
                { icon: '‚úàÔ∏è', title: {kk:'–í–∏–∑–∞', ru:'–í–∏–∑–∞'}, desc: {kk:'–¢–æ–ª—ã“õ —Ä–µ—Å—ñ–º–¥–µ—É', ru:'–ü–æ–ª–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ'} },
                { icon: 'üè®', title: {kk:'–û—Ç–µ–ª—å 5‚òÖ', ru:'–û—Ç–µ–ª–∏ 5‚òÖ'}, desc: {kk:'–ü—Ä–µ–º–∏—É–º –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—É', ru:'–ü—Ä–µ–º–∏—É–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ'} },
                { icon: 'üöå', title: {kk:'–¢—Ä–∞–Ω—Å—Ñ–µ—Ä', ru:'–¢—Ä–∞–Ω—Å—Ñ–µ—Ä'}, desc: {kk:'–ñ–∞–π–ª—ã –∫”©–ª—ñ–∫', ru:'–ö–æ–º—Ñ–æ—Ä—Ç–∞–±–µ–ª—å–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'} }
            ],
            transfer: [
                { icon: 'üöå', title: {kk:'”ò—É–µ–∂–∞–π–¥–∞–Ω “õ–æ–Ω–∞“õ“Ø–π–≥–µ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä', ru:'–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∞—ç—Ä–æ–ø–æ—Ä—Ç‚Äì–æ—Ç–µ–ª—å'}, desc: {kk:'Mercedes Sprinter, –∫–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å', ru:'Mercedes Sprinter, –∫–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å'} },
                { icon: 'üë§', title: {kk:'–ì–∏–¥', ru:'–ì–∏–¥'}, desc: {kk:'“ö–∞–∑–∞“õ/–æ—Ä—ã—Å —Ç—ñ–ª–¥—ñ —Å“Ø–π–µ–º–µ–ª–¥–µ—É', ru:'–†—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç –≤—Å—é –ø–æ–µ–∑–¥–∫—É'} }
            ],
            cta: {
                title: {kk:'“ö–∞–∑—ñ—Ä –∂–∞–∑—ã–ª—ã“£—ã–∑', ru:'–ù–∞–ø–∏—à–∏—Ç–µ —Å–µ–π—á–∞—Å'},
                subtitle: {kk:'–°“±—Ä–∞“õ—Ç–∞—Ä—ã“£—ã–∑ –±–æ–ª—Å–∞', ru:'–û—Ç–≤–µ—á–∞–µ–º –±—ã—Å—Ç—Ä–æ'},
                button: {kk:'WhatsApp-“õ–∞ –∂–∞–∑—É', ru:'–ù–∞–ø–∏—Å–∞—Ç—å –≤ WhatsApp'},
                phone: '+7 705 377 62 88',
                message: {kk:'–°”ô–ª–µ–º! “∞–º—Ä–∞ –ø–∞–∫–µ—Ç—ñ', ru:'–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å –ø–∞–∫–µ—Ç–æ–º'}
            },
            ctaFooter: {
                phoneLabel: {kk:'–¢–µ–ª–µ—Ñ–æ–Ω', ru:'–¢–µ–ª–µ—Ñ–æ–Ω'},
                whatsappLabel: {kk:'WhatsApp', ru:'WhatsApp'},
                phone: '+7 705 377 62 88',
                waMessage: {kk:'–°”ô–ª–µ–º! “∞–º—Ä–∞ –ø–∞–∫–µ—Ç—ñ –∂–∞–π–ª—ã –∞“õ–ø–∞—Ä–∞—Ç –∫–µ—Ä–µ–∫', ru:'–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å –ø–∞–∫–µ—Ç–æ–º –£–º—Ä–∞'}
            },
            texts: {
                hotelsHeading: {kk:'“ö–æ–Ω–∞“õ“Ø–π–ª–µ—Ä', ru:'–û—Ç–µ–ª–∏'},
                pricesHeading: {kk:'–ë–∞“ì–∞–ª–∞—Ä', ru:'–¶–µ–Ω—ã'},
                servicesHeading: {kk:'“ö—ã–∑–º–µ—Ç—Ç–µ—Ä', ru:'–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ'},
                transferHeading: {kk:'–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∂”ô–Ω–µ –ì–∏–¥', ru:'–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∏ –ì–∏–¥'}
            }
        };
        
        // Ensure photos array for backward compatibility
        state.hotels = state.hotels.map(h => ({
            ...h,
            photos: h.photos?.slice(0,3) || (h.photo ? [h.photo] : []).slice(0,1)
        }));
        
        function showToast(msg, type='success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            content.classList.toggle('open');
            arrow.textContent = content.classList.contains('open') ? '‚ñ≤' : '‚ñº';
        }
        
        function renderCTASection() {
            const digits = state.cta.phone.replace(/\D/g,'');
            const msg = encodeURIComponent(state.cta.message[i18n.lang] || '');
            const wa = `https://wa.me/${digits}?text=${msg}`;
            return `
                <div class="cta-section">
                    <h3>${state.cta.title[i18n.lang]}</h3>
                    <p>${state.cta.subtitle[i18n.lang]}</p>
                    <a href="${wa}" class="btn" target="_blank" rel="noopener noreferrer">${state.cta.button[i18n.lang]}</a>
                </div>
            `;
        }
        
        function renderContactFooter() {
            const digits = state.ctaFooter.phone.replace(/\D/g,'');
            const msg = encodeURIComponent(state.ctaFooter.waMessage[i18n.lang] || '');
            const wa = `https://wa.me/${digits}?text=${msg}`;
            return `
                <div class="contact-footer">
                    <div class="contact-item">
                        <span style="font-size: 24px;">üìû</span>
                        <span><strong>${state.ctaFooter.phoneLabel[i18n.lang]}:</strong> ${state.ctaFooter.phone}</span>
                    </div>
                    <a href="${wa}" class="wa-button" target="_blank" rel="noopener noreferrer">üí¨ ${state.ctaFooter.whatsappLabel[i18n.lang]}</a>
                </div>
            `;
        }
        
        function getHotelPhotosHTML(photos, count = 3) {
            const validPhotos = photos.filter(p => p).slice(0, count);
            if (validPhotos.length === 0) return '<div style="background: #e0e0e0; grid-column: 1/-1; height: 100%;"></div>';
            
            // Duplicate photos smartly if less than count
            while (validPhotos.length < count && validPhotos.length > 0) {
                validPhotos.push(validPhotos[validPhotos.length - 1]);
            }
            
            return validPhotos.map(url => `<img src="${url}" crossorigin="anonymous" alt="Hotel">`).join('');
        }
        
        // NEW: Stylish Modern Template
        function renderStylishModern() {
            const firstPhoto = state.hotels[0]?.photos?.filter(p=>p)[0] || '';
            const hotels = state.hotels.map(h => `
                <div class="hotel-card">
                    <div class="hotel-photos">${getHotelPhotosHTML(h.photos, 3)}</div>
                    <div class="hotel-info">
                        <div class="hotel-city">${h.city}</div>
                        <h3 class="hotel-name">${h.name}</h3>
                        <div class="hotel-meta">${'‚≠ê'.repeat(h.stars)} ¬∑ ${h.rating} ¬∑ üìç ${h.distance}</div>
                    </div>
                </div>
            `).join('');
            
            const prices = state.prices.map(p => `
                <div class="price-card">
                    <div class="price-label">${p.label}</div>
                    <div class="price-value">${p.value}</div>
                </div>
            `).join('');
            
            const services = state.services.map(s => `
                <div class="service-card">
                    <div class="service-icon">${s.icon}</div>
                    <div class="service-title">${s.title[i18n.lang]}</div>
                    <div class="service-desc">${s.desc[i18n.lang]}</div>
                </div>
            `).join('');
            
            const transfer = state.transfer.map(t => `
                <div class="transfer-item">
                    <div class="transfer-icon">${t.icon}</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${t.title[i18n.lang]}</div>
                        <div style="font-size: 14px; color: #666;">${t.desc[i18n.lang]}</div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="template-stylish-modern">
                    <div class="hero-modern">
                        <div class="hero-text">
                            <h1>${state.brandName}</h1>
                            <h2>${state.packageTitle}</h2>
                            <p>${state.tagline}</p>
                        </div>
                        ${firstPhoto ? `<img src="${firstPhoto}" class="hero-image" crossorigin="anonymous" alt="Hero">` : '<div style="background: #e0e0e0; border-radius: 16px; height: 100%;"></div>'}
                    </div>
                    <div class="content-section">
                        <h2 class="section-heading">${t('hotelsHeading')}</h2>
                        <div class="hotels-grid">${hotels}</div>
                        <h2 class="section-heading">${t('pricesHeading')}</h2>
                        <div class="prices-grid">${prices}</div>
                        <h2 class="section-heading">${t('servicesHeading')}</h2>
                        <div class="services-grid">${services}</div>
                        <h2 class="section-heading">${t('transferHeading')}</h2>
                        <div class="transfer-list">${transfer}</div>
                        ${renderCTASection()}
                    </div>
                    ${renderContactFooter()}
                </div>
            `;
        }
        
        // NEW: Apple Style Template
        function renderAppleStyle() {
            const hotels = state.hotels.map(h => `
                <div class="hotel-glass">
                    <div class="hotel-photos-glass">${getHotelPhotosHTML(h.photos, 3)}</div>
                    <div class="hotel-info-glass">
                        <div class="hotel-city-glass">${h.city}</div>
                        <h3 class="hotel-name-glass">${h.name}</h3>
                        <div style="font-size: 16px; color: #666; margin-top: 12px;">${'‚≠ê'.repeat(h.stars)} ¬∑ ${h.rating} ¬∑ üìç ${h.distance}</div>
                    </div>
                </div>
            `).join('');
            
            const prices = state.prices.map(p => `
                <div class="price-billboard">
                    <div class="price-label-big">${p.label}</div>
                    <div class="price-value-big">${p.value}</div>
                </div>
            `).join('');
            
            const services = state.services.map(s => `
                <div class="service-glass">
                    <div class="service-icon-glass">${s.icon}</div>
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">${s.title[i18n.lang]}</div>
                    <div style="font-size: 14px; color: #666;">${s.desc[i18n.lang]}</div>
                </div>
            `).join('');
            
            const transfer = state.transfer.map(t => `
                <div class="transfer-glass-item">
                    <div style="font-size: 32px; min-width: 48px;">${t.icon}</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${t.title[i18n.lang]}</div>
                        <div style="font-size: 14px; color: #666;">${t.desc[i18n.lang]}</div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="template-apple-style">
                    <div class="glass-header">
                        <h1 class="brand-name">${state.brandName}</h1>
                        <h2 class="package-title">${state.packageTitle}</h2>
                        <p class="package-subtitle">${state.packageSubtitle}</p>
                    </div>
                    <div class="content">
                        <h2 class="section-heading">${t('hotelsHeading')}</h2>
                        <div class="hotels-grid">${hotels}</div>
                        <h2 class="section-heading">${t('pricesHeading')}</h2>
                        <div class="prices-billboard">${prices}</div>
                        <h2 class="section-heading">${t('servicesHeading')}</h2>
                        <div class="services-glass">${services}</div>
                        <h2 class="section-heading">${t('transferHeading')}</h2>
                        <div class="transfer-glass-list">${transfer}</div>
                        ${renderCTASection()}
                    </div>
                    ${renderContactFooter()}
                </div>
            `;
        }
        
        // NEW: Modern Minimal Aesthetic Template
        function renderModernMinimal() {
            const hotels = state.hotels.map(h => `
                <div class="hotel-minimal">
                    <div class="hotel-photos-minimal">${getHotelPhotosHTML(h.photos, 3)}</div>
                    <div class="hotel-info-minimal">
                        <div class="hotel-city-minimal">${h.city}</div>
                        <h3 class="hotel-name-minimal">${h.name}</h3>
                        <div style="font-size: 14px; color: #666; margin-top: 8px;">${'‚≠ê'.repeat(h.stars)} ¬∑ ${h.rating} ¬∑ ${h.distance}</div>
                    </div>
                </div>
            `).join('');
            
            const prices = state.prices.map((p, i) => `
                <div class="price-tab ${i===0?'active':''}" onclick="this.parentElement.querySelectorAll('.price-tab').forEach(t=>t.classList.remove('active')); this.classList.add('active');">
                    <div class="price-tab-label">${p.label}</div>
                    <div class="price-tab-value">${p.value}</div>
                </div>
            `).join('');
            
            const services = state.services.map(s => `
                <div class="service-minimal">
                    <div class="service-icon-minimal">${s.icon}</div>
                    <div>
                        <div class="service-title-minimal">${s.title[i18n.lang]}</div>
                        <div style="font-size: 14px; color: #666;">${s.desc[i18n.lang]}</div>
                    </div>
                </div>
            `).join('');
            
            const transfer = state.transfer.map(t => `
                <div class="transfer-minimal-item">
                    <div style="font-size: 32px; min-width: 48px;">${t.icon}</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 4px;">${t.title[i18n.lang]}</div>
                        <div style="font-size: 14px; color: #666;">${t.desc[i18n.lang]}</div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="template-modern-minimal">
                    <div class="header-minimal">
                        <h1 class="brand-name-minimal">${state.brandName}</h1>
                        <h2 class="package-title-minimal">${state.packageTitle}</h2>
                        <p class="package-subtitle-minimal">${state.packageSubtitle}</p>
                    </div>
                    <h2 class="section-heading-minimal">${t('hotelsHeading')}</h2>
                    <div class="hotels-minimal">${hotels}</div>
                    <h2 class="section-heading-minimal">${t('pricesHeading')}</h2>
                    <div class="prices-tabs">${prices}</div>
                    <h2 class="section-heading-minimal">${t('servicesHeading')}</h2>
                    <div class="services-minimal">${services}</div>
                    <h2 class="section-heading-minimal">${t('transferHeading')}</h2>
                    <div class="transfer-minimal-list">${transfer}</div>
                    ${renderCTASection()}
                    ${renderContactFooter()}
                </div>
            `;
        }
        
        // Keep existing minimal templates (simplified versions from previous file)
        function renderMinimalColumn() {
            const hotels = state.hotels.map(h => `
                <div style="margin-bottom: 48px; padding-bottom: 48px; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-size: 11px; text-transform: uppercase; color: #999;">${h.city}</div>
                    <h3 style="font-size: 32px; font-weight: 300; margin: 8px 0;">${h.name}</h3>
                    <div style="font-size: 14px; color: #666; margin: 16px 0;">${'‚≠ê'.repeat(h.stars)} ¬∑ ${h.rating} ¬∑ ${h.distance}</div>
                    <div style="display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-top: 24px;">${getHotelPhotosHTML(h.photos, 3)}</div>
                </div>
            `).join('');
            return `<div style="max-width: 700px; margin: 0 auto; padding: 80px 32px; font-family: Inter;">
                <div style="text-align: center; margin-bottom: 80px;"><h1 style="font-size: 56px; font-weight: 300;">${state.brandName}</h1>
                <h2 style="font-size: 64px; font-weight: 300; margin: 64px 0 16px;">${state.packageTitle}</h2></div>
                <h3 style="font-size: 24px; margin: 64px 0 32px; border-bottom: 1px solid #ddd; padding-bottom: 16px;">${t('hotelsHeading')}</h3>${hotels}
                ${renderCTASection()}${renderContactFooter()}</div>`;
        }
        
        function renderMinimalSplit() {
            return `<div style="font-family: Inter;"><div style="display: grid; grid-template-columns: 1fr 1fr; min-height: 500px;">
                <div style="padding: 64px; display: flex; flex-direction: column; justify-content: center;">
                <h1 style="font-size: 48px; font-weight: 300;">${state.brandName}</h1>
                <h2 style="font-size: 56px; font-weight: 600; line-height: 1.1; margin: 16px 0;">${state.packageTitle}</h2></div>
                <div style="background: #f5f5f5;"></div></div>${renderCTASection()}${renderContactFooter()}</div>`;
        }
        
        function renderMinimalTimeline() {
            return `<div style="max-width: 1000px; margin: 0 auto; padding: 64px 32px; font-family: Inter;">
                <div style="text-align: center; margin-bottom: 80px;"><h1 style="font-size: 48px;">${state.brandName}</h1>
                <h2 style="font-size: 64px; font-weight: 600; margin: 16px 0;">${state.packageTitle}</h2></div>
                ${renderCTASection()}${renderContactFooter()}</div>`;
        }
        
        function render() {
            const sheet = document.getElementById('previewSheet');
            switch(state.template) {
                case 'stylish-modern': sheet.innerHTML = renderStylishModern(); break;
                case 'apple-style': sheet.innerHTML = renderAppleStyle(); break;
                case 'modern-minimal': sheet.innerHTML = renderModernMinimal(); break;
                case 'minimal-column': sheet.innerHTML = renderMinimalColumn(); break;
                case 'minimal-split': sheet.innerHTML = renderMinimalSplit(); break;
                case 'minimal-timeline': sheet.innerHTML = renderMinimalTimeline(); break;
                default: sheet.innerHTML = renderStylishModern();
            }
        }
        
        function renderHotelsList() {
            document.getElementById('hotelsList').innerHTML = state.hotels.map((h, i) => {
                const photosHTML = (h.photos || []).map((photo, pi) => `
                    <div class="photo-item">
                        <input type="url" value="${photo}" oninput="state.hotels[${i}].photos[${pi}]=this.value; render();" placeholder="URL —Ñ–æ—Ç–æ ${pi+1}">
                        <button class="btn-delete" onclick="state.hotels[${i}].photos.splice(${pi},1); renderHotelsList(); render();">üóëÔ∏è</button>
                    </div>
                `).join('');
                
                return `
                <div class="list-item">
                    <div class="list-item-header">
                        <span>–û—Ç–µ–ª—å ${i+1}</span>
                        <button class="btn-delete" onclick="state.hotels.splice(${i},1); renderHotelsList(); render();">üóëÔ∏è</button>
                    </div>
                    <input type="text" value="${h.city}" oninput="state.hotels[${i}].city=this.value; render();" placeholder="–ì–æ—Ä–æ–¥" style="margin-bottom: 8px;">
                    <input type="text" value="${h.name}" oninput="state.hotels[${i}].name=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom: 8px;">
                    <div class="form-row">
                        <input type="number" value="${h.stars}" oninput="state.hotels[${i}].stars=parseInt(this.value); render();" placeholder="–ó–≤—ë–∑–¥—ã">
                        <input type="number" step="0.1" value="${h.rating}" oninput="state.hotels[${i}].rating=parseFloat(this.value); render();" placeholder="–†–µ–π—Ç–∏–Ω–≥">
                    </div>
                    <input type="text" value="${h.distance}" oninput="state.hotels[${i}].distance=this.value; render();" placeholder="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ" style="margin: 8px 0;">
                    <div style="font-weight: 600; margin: 12px 0 8px;">–§–æ—Ç–æ (–¥–æ 3):</div>
                    <div class="photo-list">${photosHTML}</div>
                    ${(h.photos || []).length < 3 ? `<button class="btn btn-secondary btn-small" onclick="if(!state.hotels[${i}].photos) state.hotels[${i}].photos=[]; if(state.hotels[${i}].photos.length<3) state.hotels[${i}].photos.push(''); renderHotelsList(); render();">+ –§–æ—Ç–æ</button>` : ''}
                </div>
            `}).join('');
        }
        
        function renderPricesList() {
            document.getElementById('pricesList').innerHTML = state.prices.map((p, i) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span>–¶–µ–Ω–∞ ${i+1}</span>
                        <button class="btn-delete" onclick="state.prices.splice(${i},1); renderPricesList(); render();">üóëÔ∏è</button>
                    </div>
                    <div class="form-row">
                        <input type="text" value="${p.label}" oninput="state.prices[${i}].label=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                        <input type="text" value="${p.value}" oninput="state.prices[${i}].value=this.value; render();" placeholder="–¶–µ–Ω–∞">
                    </div>
                </div>
            `).join('');
        }
        
        function renderServicesList() {
            document.getElementById('servicesList').innerHTML = state.services.map((s, i) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span>–£—Å–ª—É–≥–∞ ${i+1}</span>
                        <button class="btn-delete" onclick="state.services.splice(${i},1); renderServicesList(); render();">üóëÔ∏è</button>
                    </div>
                    <input type="text" value="${s.icon}" oninput="state.services[${i}].icon=this.value; render();" placeholder="–ò–∫–æ–Ω–∫–∞" style="margin-bottom: 8px;">
                    <div class="form-row">
                        <input type="text" value="${s.title.kk}" oninput="state.services[${i}].title.kk=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ KK">
                        <input type="text" value="${s.title.ru}" oninput="state.services[${i}].title.ru=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ RU">
                    </div>
                    <div class="form-row" style="margin-top: 8px;">
                        <input type="text" value="${s.desc.kk}" oninput="state.services[${i}].desc.kk=this.value; render();" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ KK">
                        <input type="text" value="${s.desc.ru}" oninput="state.services[${i}].desc.ru=this.value; render();" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ RU">
                    </div>
                </div>
            `).join('');
        }
        
        function renderTransferList() {
            document.getElementById('transferList').innerHTML = state.transfer.map((t, i) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä ${i+1}</span>
                        <button class="btn-delete" onclick="state.transfer.splice(${i},1); renderTransferList(); render();">üóëÔ∏è</button>
                    </div>
                    <input type="text" value="${t.icon}" oninput="state.transfer[${i}].icon=this.value; render();" placeholder="–ò–∫–æ–Ω–∫–∞" style="margin-bottom: 8px;">
                    <div class="form-row">
                        <input type="text" value="${t.title.kk}" oninput="state.transfer[${i}].title.kk=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ KK">
                        <input type="text" value="${t.title.ru}" oninput="state.transfer[${i}].title.ru=this.value; render();" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ RU">
                    </div>
                    <div class="form-row" style="margin-top: 8px;">
                        <input type="text" value="${t.desc.kk}" oninput="state.transfer[${i}].desc.kk=this.value; render();" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ KK">
                        <input type="text" value="${t.desc.ru}" oninput="state.transfer[${i}].desc.ru=this.value; render();" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ RU">
                    </div>
                </div>
            `).join('');
        }
        
        function renderCTAEditor() {
            document.getElementById('ctaEditor').innerHTML = `
                <div class="form-row"><input type="text" value="${state.cta.title.kk}" oninput="state.cta.title.kk=this.value; render();" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ KK">
                <input type="text" value="${state.cta.title.ru}" oninput="state.cta.title.ru=this.value; render();" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ RU"></div>
                <div class="form-row" style="margin-top: 8px;"><input type="text" value="${state.cta.subtitle.kk}" oninput="state.cta.subtitle.kk=this.value; render();" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ KK">
                <input type="text" value="${state.cta.subtitle.ru}" oninput="state.cta.subtitle.ru=this.value; render();" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ RU"></div>
                <div class="form-row" style="margin-top: 8px;"><input type="text" value="${state.cta.button.kk}" oninput="state.cta.button.kk=this.value; render();" placeholder="–ö–Ω–æ–ø–∫–∞ KK">
                <input type="text" value="${state.cta.button.ru}" oninput="state.cta.button.ru=this.value; render();" placeholder="–ö–Ω–æ–ø–∫–∞ RU"></div>
                <input type="text" value="${state.cta.phone}" oninput="state.cta.phone=this.value; renderCTAEditor(); render();" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" style="margin-top: 8px;">
                <div class="form-row" style="margin-top: 8px;"><input type="text" value="${state.cta.message.kk}" oninput="state.cta.message.kk=this.value; render();" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ KK">
                <input type="text" value="${state.cta.message.ru}" oninput="state.cta.message.ru=this.value; render();" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ RU"></div>
                <small style="color: #666; display: block; margin-top: 8px;">wa.me/${state.cta.phone.replace(/\D/g,'')}</small>
            `;
        }
        
        function renderContactEditor() {
            document.getElementById('contactEditor').innerHTML = `
                <div class="form-row"><input type="text" value="${state.ctaFooter.phoneLabel.kk}" oninput="state.ctaFooter.phoneLabel.kk=this.value; render();" placeholder="–ú–µ—Ç–∫–∞ –¢–µ–ª–µ—Ñ–æ–Ω KK">
                <input type="text" value="${state.ctaFooter.phoneLabel.ru}" oninput="state.ctaFooter.phoneLabel.ru=this.value; render();" placeholder="–ú–µ—Ç–∫–∞ –¢–µ–ª–µ—Ñ–æ–Ω RU"></div>
                <input type="text" value="${state.ctaFooter.phone}" oninput="state.ctaFooter.phone=this.value; renderContactEditor(); render();" placeholder="–ù–æ–º–µ—Ä" style="margin-top: 8px;">
                <div class="form-row" style="margin-top: 8px;"><input type="text" value="${state.ctaFooter.whatsappLabel.kk}" oninput="state.ctaFooter.whatsappLabel.kk=this.value; render();" placeholder="–ú–µ—Ç–∫–∞ WA KK">
                <input type="text" value="${state.ctaFooter.whatsappLabel.ru}" oninput="state.ctaFooter.whatsappLabel.ru=this.value; render();" placeholder="–ú–µ—Ç–∫–∞ WA RU"></div>
                <div class="form-row" style="margin-top: 8px;"><input type="text" value="${state.ctaFooter.waMessage.kk}" oninput="state.ctaFooter.waMessage.kk=this.value; render();" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ KK">
                <input type="text" value="${state.ctaFooter.waMessage.ru}" oninput="state.ctaFooter.waMessage.ru=this.value; render();" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ RU"></div>
            `;
        }
        
        function renderTextsEditor() {
            document.getElementById('textsEditor').innerHTML = Object.keys(state.texts).map(key => `
                <div style="margin-bottom: 12px;">
                    <label style="margin-bottom: 4px;">${key}</label>
                    <div class="form-row">
                        <input type="text" value="${state.texts[key].kk}" oninput="state.texts['${key}'].kk=this.value; render();" placeholder="KK">
                        <input type="text" value="${state.texts[key].ru}" oninput="state.texts['${key}'].ru=this.value; render();" placeholder="RU">
                    </div>
                </div>
            `).join('');
        }
        
        async function exportPDF() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('active');
            try {
                await document.fonts.ready;
                await new Promise(r => setTimeout(r, 400));
                const sheet = document.getElementById('previewSheet');
                const canvas = await html2canvas(sheet, { scale: 2, useCORS: true, allowTaint: true, logging: false, backgroundColor: getComputedStyle(sheet).backgroundColor || '#ffffff' });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height], compress: true });
                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height, undefined, 'FAST');
                pdf.save(`${state.brandName}_${state.template}_${Date.now()}.pdf`);
                showToast('PDF —Å–æ–∑–¥–∞–Ω!');
            } catch(e) {
                console.error(e);
                showToast('–û—à–∏–±–∫–∞ PDF', 'error');
            } finally {
                overlay.classList.remove('active');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('brandName').oninput = e => { state.brandName = e.target.value; render(); };
            document.getElementById('tagline').oninput = e => { state.tagline = e.target.value; render(); };
            document.getElementById('packageTitle').oninput = e => { state.packageTitle = e.target.value; render(); };
            document.getElementById('packageSubtitle').oninput = e => { state.packageSubtitle = e.target.value; render(); };
            
            document.querySelectorAll('.template-card').forEach(card => {
                card.onclick = () => {
                    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    state.template = card.dataset.template;
                    render();
                };
            });
            
            document.getElementById('addHotel').onclick = () => {
                state.hotels.push({ city: '–ì–æ—Ä–æ–¥', name: '–û—Ç–µ–ª—å', stars: 5, rating: 9.0, distance: '500–º', photos: [] });
                renderHotelsList();
                render();
            };
            
            document.getElementById('addPrice').onclick = () => {
                state.prices.push({ label: '–¶–µ–Ω–∞', value: '$0' });
                renderPricesList();
                render();
            };
            
            document.getElementById('addService').onclick = () => {
                state.services.push({ icon: 'üéØ', title: {kk: '–ñ–∞“£–∞', ru: '–ù–æ–≤–∞—è'}, desc: {kk: '–°–∏–ø–∞—Ç', ru: '–û–ø–∏—Å–∞–Ω–∏–µ'} });
                renderServicesList();
                render();
            };
            
            document.getElementById('addTransfer').onclick = () => {
                state.transfer.push({ icon: 'üöó', title: {kk: '–ñ–∞“£–∞', ru: '–ù–æ–≤—ã–π'}, desc: {kk: '–°–∏–ø–∞—Ç', ru: '–û–ø–∏—Å–∞–Ω–∏–µ'} });
                renderTransferList();
                render();
            };
            
            document.getElementById('exportPDF').onclick = exportPDF;
            
            document.getElementById('saveJSON').onclick = () => {
                const data = { ...state, currentLang: i18n.lang };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `atlas_v3_${Date.now()}.json`;
                a.click();
                showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            };
            
            document.getElementById('loadJSON').onclick = () => document.getElementById('jsonInput').click();
            
            document.getElementById('jsonInput').onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            const loaded = JSON.parse(ev.target.result);
                            // Ensure photos array
                            if (loaded.hotels) {
                                loaded.hotels = loaded.hotels.map(h => ({
                                    ...h,
                                    photos: h.photos?.slice(0,3) || (h.photo ? [h.photo] : []).slice(0,1)
                                }));
                            }
                            if (loaded.currentLang) { i18n.lang = loaded.currentLang; setLang(loaded.currentLang); }
                            state = loaded;
                            document.getElementById('brandName').value = state.brandName;
                            document.getElementById('tagline').value = state.tagline;
                            document.getElementById('packageTitle').value = state.packageTitle;
                            document.getElementById('packageSubtitle').value = state.packageSubtitle;
                            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                            document.querySelector(`[data-template="${state.template}"]`)?.classList.add('active');
                            renderHotelsList();
                            renderPricesList();
                            renderServicesList();
                            renderTransferList();
                            renderCTAEditor();
                            renderContactEditor();
                            renderTextsEditor();
                            render();
                            showToast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
                        } catch(err) {
                            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            // Set initial language from localStorage
            setLang(i18n.lang);
            
            renderHotelsList();
            renderPricesList();
            renderServicesList();
            renderTransferList();
            renderCTAEditor();
            renderContactEditor();
            renderTextsEditor();
            render();
        });
    </script>
</body>
</html>